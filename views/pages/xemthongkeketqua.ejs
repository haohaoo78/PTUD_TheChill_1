<h1>Xem thống kê kết quả</h1>

<% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
<% } %>

<form id="thongkeForm" action="/api/xemthongkeketqua/render" method="POST">
    <% if (user.role === 'Hiệu trưởng' || user.role === 'Giáo viên') { %>
        <div class="form-group">
            <label for="maLop">Lớp:</label>
            <select name="maLop" id="maLop">
                <option value="">-- Chọn lớp --</option>
                <% classes.forEach(cls => { %>
                    <option value="<%= cls.MaLop %>" <%= maLop === cls.MaLop ? 'selected' : '' %>>
                        <%= cls.TenLop %>
                    </option>
                <% }) %>
            </select>
        </div>
    <% } %>

    <% if (user.role === 'Hiệu trưởng' || user.role === 'Giáo vụ') { %>
        <div class="form-group">
            <label for="tenMonHoc">Môn học:</label>
            <select name="tenMonHoc" id="tenMonHoc">
                <option value="">-- Chọn môn (tùy chọn) --</option>
                <% subjects.forEach(sub => { %>
                    <option value="<%= sub.TenMonHoc %>" <%= tenMonHoc === sub.TenMonHoc ? 'selected' : '' %>>
                        <%= sub.TenMonHoc %>
                    </option>
                <% }) %>
            </select>
        </div>
    <% } %>

    <div class="form-group">
        <label for="namHoc">Năm học:</label>
        <select name="namHoc" id="namHoc" required>
            <option value="">-- Chọn năm --</option>
            <% semesters.forEach(sem => { %>
                <option value="<%= sem.NamHoc %>" <%= namHoc === sem.NamHoc ? 'selected' : '' %>>
                    <%= sem.NamHoc %>
                </option>
            <% }) %>
        </select>
    </div>

    <div class="form-group">
        <label for="kyHoc">Học kỳ:</label>
        <select name="kyHoc" id="kyHoc" required>
            <option value="">-- Chọn kỳ --</option>
            <option value="1" <%= kyHoc === '1' ? 'selected' : '' %>>1</option>
            <option value="2" <%= kyHoc === '2' ? 'selected' : '' %>>2</option>
        </select>
    </div>

    <button type="submit" id="submitBtn">Xem thống kê</button>
    <button type="button" id="cancelBtn">Hủy</button>
</form>

<div id="loader" style="display: none; margin-top: 20px; text-align: center;">Đang tải...</div>

<% if (stats && stats.length > 0) { %>
    <h2 style="margin-top: 40px;">Kết quả thống kê</h2>
    
    <table class="table">
        <thead>
            <tr>
                <th>Môn học</th>
                <th>Điểm TB</th>
                <th>Tỷ lệ đạt (%)</th>
                <th>Tỷ lệ không đạt (%)</th>
                <th>Tổng HS</th>
            </tr>
        </thead>
        <tbody>
            <% stats.forEach(stat => { %>
                <tr>
                    <td><%= stat.TenMonHoc %></td>
                    <td><%= stat.DiemTB ? Number(stat.DiemTB).toFixed(2) : '0.00' %></td>
                    <td><%= stat.TyLeDat ? Number(stat.TyLeDat).toFixed(2) : '0.00' %></td>
                    <td><%= stat.TyLeKhongDat ? Number(stat.TyLeKhongDat).toFixed(2) : '0.00' %></td>
                    <td><%= stat.TongHS %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>

    <div style="margin-top: 40px; display: flex; flex-wrap: wrap; gap: 40px; justify-content: center;">
        <canvas id="pieChart" width="400" height="400"></canvas>
        <canvas id="barChart" width="600" height="400"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const statsData = JSON.parse('<%- JSON.stringify(stats || []) %>');

        if (Array.isArray(statsData) && statsData.length > 0) {
            const labels = statsData.map(s => s.TenMonHoc || 'Không tên');
            const tyLeDat = statsData.map(s => s.TyLeDat ? parseFloat(s.TyLeDat) : 0);
            const diemTB = statsData.map(s => s.DiemTB ? parseFloat(s.DiemTB) : 0);

            const avgDat = tyLeDat.reduce((a, b) => a + b, 0) / tyLeDat.length || 0;
            const totalDat = avgDat.toFixed(2);
            const totalKhongDat = (100 - avgDat).toFixed(2);

            new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: ['Đạt', 'Không đạt'],
                    datasets: [{
                        data: [totalDat, totalKhongDat],
                        backgroundColor: ['#36A2EB', '#FF6384'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Tỷ lệ đạt / không đạt tổng thể' },
                        legend: { position: 'bottom' }
                    }
                }
            });

            new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm trung bình',
                        data: diemTB,
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 10 } },
                    plugins: { title: { display: true, text: 'Điểm trung bình theo môn học' } }
                }
            });
        }
    </script>
<% } else if (stats !== undefined) { %>
    <p style="margin-top: 40px; color: red; text-align: center;">Không có dữ liệu thống kê phù hợp với điều kiện đã chọn.</p>
<% } %>

<link rel="stylesheet" href="/css/xemthongkeketqua.css">