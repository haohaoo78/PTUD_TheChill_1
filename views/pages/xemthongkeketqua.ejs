<!-- views/pages/xemthongkeketqua.ejs - Chỉ nội dung chính, không header/sidebar/footer -->

<div class="container mt-4">
    <h1 class="text-center mb-4">Xem thống kê kết quả</h1>

    <% if (error) { %>
        <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>

    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            <h5>Năm học: <strong><%= currentNamHoc %></strong></h5>
            <% if (user.role === 'Giáo viên' && gvcnClass) { %>
                <h5>Lớp chủ nhiệm: <strong><%= gvcnClass %></strong></h5>
            <% } else if (user.role === 'Hiệu trưởng') { %>
                <h5>Toàn trường (hoặc chọn lớp bên dưới)</h5>
            <% } %>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form id="thongkeForm">
                <% if (user.role === 'Hiệu trưởng') { %>
                    <div class="form-group mb-3">
                        <label for="maLop" class="form-label">Lớp (tùy chọn):</label>
                        <select name="maLop" id="maLop" class="form-select">
                            <option value="">-- Toàn trường --</option>
                            <% classes.forEach(cls => { %>
                                <option value="<%= cls.MaLop %>" <%= maLop === cls.MaLop ? 'selected' : '' %>>
                                    <%= cls.TenLop %>
                                </option>
                            <% }) %>
                        </select>
                    </div>
                <% } %>

                <div class="form-group mb-3">
                    <label for="kyHoc" class="form-label">Học kỳ:</label>
                    <select name="kyHoc" id="kyHoc" class="form-select" required>
                        <option value="1" <%= kyHoc === '1' ? 'selected' : '' %>>Học kỳ 1</option>
                        <option value="2" <%= kyHoc === '2' ? 'selected' : '' %>>Học kỳ 2</option>
                    </select>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary me-2">Xem thống kê</button>
                    <button type="button" id="cancelBtn" class="btn btn-secondary">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loader" class="text-center my-4" style="display: none;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-2">Đang tải dữ liệu...</p>
    </div>

    <div id="stats-container">
        <% if (stats && stats.length > 0) { %>
            <h2 class="text-center mb-4">Thống kê điểm các môn học</h2>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-center">
                    <thead class="table-primary">
                        <tr>
                            <th>Môn học</th>
                            <th>Điểm TB</th>
                            <th>Tỷ lệ đạt (%)</th>
                            <th>Tỷ lệ không đạt (%)</th>
                            <th>Tổng HS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% stats.forEach(stat => { %>
                            <tr>
                                <td><strong><%= stat.TenMonHoc %></strong></td>
                                <td><%= stat.DiemTB != null ? Number(stat.DiemTB).toFixed(2) : '0.00' %></td>
                                <td class="text-success"><%= stat.TyLeDat != null ? Number(stat.TyLeDat).toFixed(2) : '0.00' %></td>
                                <td class="text-danger"><%= stat.TyLeKhongDat != null ? Number(stat.TyLeKhongDat).toFixed(2) : '0.00' %></td>
                                <td><%= stat.TongHS %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <div class="row mt-5">
                <div class="col-md-6">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const statsData = JSON.parse('<%- JSON.stringify(stats || []) %>');

                const labels = statsData.map(s => s.TenMonHoc || 'Không tên');
                const tyLeDat = statsData.map(s => s.TyLeDat != null ? parseFloat(s.TyLeDat) : 0);
                const diemTB = statsData.map(s => s.DiemTB != null ? parseFloat(s.DiemTB) : 0);

                const avgDat = tyLeDat.reduce((a, b) => a + b, 0) / tyLeDat.length || 0;
                const totalDat = avgDat.toFixed(2);
                const totalKhongDat = (100 - avgDat).toFixed(2);

                new Chart(document.getElementById('pieChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Đạt', 'Không đạt'],
                        datasets: [{
                            data: [totalDat, totalKhongDat],
                            backgroundColor: ['#36A2EB', '#FF6384'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Tỷ lệ đạt / không đạt tổng thể', font: { size: 16 } },
                            legend: { position: 'bottom' }
                        }
                    }
                });

                new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Điểm trung bình',
                            data: diemTB,
                            backgroundColor: '#36A2EB',
                            borderColor: '#2c82c9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, max: 10 } },
                        plugins: { title: { display: true, text: 'Điểm trung bình theo môn học', font: { size: 16 } } }
                    }
                });
            </script>
        <% } else if (stats !== undefined) { %>
            <div class="text-center mt-5">
                <p class="text-danger fs-4">Không có dữ liệu thống kê phù hợp với điều kiện đã chọn.</p>
            </div>
        <% } %>
    </div>
</div>

<link rel="stylesheet" href="/css/xemthongkeketqua.css">

<script>
document.getElementById('thongkeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {};
    for (let [key, value] of formData) {
        data[key] = value;
    }
    document.getElementById('loader').style.display = 'block';
    document.getElementById('stats-container').innerHTML = '';
    try {
        const response = await fetch('/api/xemthongkeketqua/render', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        });
        if (response.ok) {
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newStatsContainer = doc.getElementById('stats-container');
            if (newStatsContainer) {
                document.getElementById('stats-container').innerHTML = newStatsContainer.innerHTML;
                // Execute scripts in the inserted HTML
                const scripts = newStatsContainer.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.src) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        document.head.appendChild(newScript);
                    } else {
                        eval(script.textContent);
                    }
                });
            } else {
                document.getElementById('stats-container').innerHTML = html;
            }
        } else {
            document.getElementById('stats-container').innerHTML = '<p class="text-danger">Lỗi tải dữ liệu.</p>';
        }
    } catch (error) {
        document.getElementById('stats-container').innerHTML = '<p class="text-danger">Lỗi kết nối.</p>';
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
});

document.getElementById('cancelBtn').addEventListener('click', function() {
    document.getElementById('stats-container').innerHTML = '';
});
</script>