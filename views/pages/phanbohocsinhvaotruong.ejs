<!-- views/pages/phanbohocsinhvaotruong.ejs -->
<link rel="stylesheet" href="/css/nhapdiemthituyensinh.css">
<link rel="stylesheet" href="/css/phanbohocsinhvaotruong.css">

<div class="nhapdiem-wrapper">
  <h2 class="nhapdiem-title text-primary fw-bold">PHÂN BỔ HỌC SINH VÀO TRƯỜNG THPT</h2>

  <div class="card select-card mb-5">
    <div class="card-header select-header text-white bg-primary">
      <h5 class="mb-0">Chọn Năm Thi</h5>
    </div>
    <div class="card-body p-5">
      <div class="row g-4 justify-content-center">
        <div class="col-lg-4">
          <select id="nam_thi" class="form-select form-select-lg">
            <option value="">-- Chọn năm thi --</option>
          </select>
        </div>
        <div class="col-lg-4 d-flex align-items-end">
          <button id="loadData" class="btn btn-primary btn-lg w-100" disabled>
            <i class="fas fa-download"></i> Tải Dữ Liệu
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="quotaArea"></div>
  <div id="resultArea"></div>

  <!-- Thanh lưu kết quả -->
  <div id="saveBar" class="position-fixed bottom-0 start-0 end-0 bg-white shadow-lg p-4 d-none" style="z-index: 1050;">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div id="statsInfo" class="fs-5 fw-bold text-success"></div>
        <div>
          <button id="cancel" class="btn btn-outline-danger me-3">Hủy</button>
          <button id="save" class="btn btn-success btn-lg px-5">
            <i class="fas fa-save"></i> Lưu Kết Quả Phân Bổ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const namThi = document.getElementById('nam_thi');
  const loadData = document.getElementById('loadData');
  const quotaArea = document.getElementById('quotaArea');
  const resultArea = document.getElementById('resultArea');
  const saveBar = document.getElementById('saveBar');
  const statsInfo = document.getElementById('statsInfo');
  const saveBtn = document.getElementById('save');
  const cancelBtn = document.getElementById('cancel');

  let allocationResults = null;

  // Load năm thi
  fetch('/api/phanbohocsinhvaotruong/years')
    .then(r => r.json())
    .then(d => {
      if (d.success && d.years.length > 0) {
        namThi.innerHTML = '<option value="">-- Chọn năm thi --</option>' + 
          d.years.map(y => `<option value="${y}">${y}</option>`).join('');
      }
    });

  namThi.addEventListener('change', () => {
    loadData.disabled = !namThi.value;
  });

  loadData.addEventListener('click', async () => {
    const n = namThi.value;
    quotaArea.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><h5>Đang tải...</h5></div>';
    resultArea.innerHTML = '';

    const res = await fetch(`/api/phanbohocsinhvaotruong/data?nam_thi=${n}`);
    const json = await res.json();

    if (!json.success) {
      quotaArea.innerHTML = `<div class="alert alert-danger">${json.message}</div>`;
      return;
    }

    if (json.hasResults) {
      // ĐÃ CÓ KẾT QUẢ TỪ DB
      renderSavedResults(json, n);
    } else {
      // CHƯA CÓ → HIỆN CHỈ TIÊU + NÚT PHÂN BỔ
      renderQuotas(json.quotas, n);
    }
  });

  function renderSavedResults(data, year) {
    let html = `<div class="result-card mt-4">
      <div class="result-header bg-success">KẾT QUẢ PHÂN BỔ NĂM ${year} (ĐÃ LƯU TRONG CSDL)</div>
      <div class="p-4">
        <div class="alert alert-info">
          Tổng thí sinh: <strong>${data.totalCandidates}</strong> | 
          Đã phân bổ: <strong class="text-success">${data.totalAllocated}</strong> | 
          Chưa trúng tuyển: <strong class="text-danger">${data.totalCandidates - data.totalAllocated}</strong>
        </div>

        <h5 class="mt-4 text-primary">Thống kê theo trường</h5>
        <table class="table table-bordered table-hover">
          <thead class="table-primary"><tr><th>Trường</th><th>Tổ hợp</th><th>Số lượng</th></tr></thead>
          <tbody>`;
    for (const school in data.stats) {
      const tenTruong = data.results.find(r => r.MaTruong === school)?.TenTruong || school;
      for (const tohop in data.stats[school]) {
        html += `<tr><td><strong>${tenTruong}</strong></td><td>${tohop}</td><td><strong>${data.stats[school][tohop]}</strong></td></tr>`;
      }
    }
    html += `</tbody></table>

        <h5 class="mt-5 text-primary">Chi tiết học sinh trúng tuyển</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr><th>Mã TS</th><th>Họ và tên</th><th>Điểm tổng</th><th>Trúng tuyển</th><th>Tổ hợp</th></tr>
            </thead>
            <tbody>`;
    data.results.forEach(r => {
      html += `<tr>
        <td><code>${r.MaThiSinh}</code></td>
        <td><strong>${r.HoTen}</strong></td>
        <td><strong class="text-danger">${r.TongDiem}</strong></td>
        <td><span class="badge bg-success fs-6">${r.TenTruong}</span></td>
        <td><code>${r.ToHopMon}</code></td>
      </tr>`;
    });
    html += `</tbody></table></div></div></div>`;
    quotaArea.innerHTML = '';
    resultArea.innerHTML = html;
  }

  function renderQuotas(quotas, year) {
    let html = `<div class="result-card">
      <div class="result-header bg-info text-white">CHỈ TIÊU TUYỂN SINH NĂM ${year}</div>
      <div class="table-responsive p-4">
        <table class="table table-bordered">
          <thead class="table-info"><tr><th>Trường</th><th>Tổ hợp môn</th><th>Chỉ tiêu</th></tr></thead>
          <tbody>`;
    for (const maTruong in quotas) {
      const school = quotas[maTruong];
      for (const tohop in school.tohops) {
        html += `<tr><td><strong>${school.TenTruong}</strong></td><td>${school.tohops[tohop].ten}</td><td><strong>${school.tohops[tohop].soluong}</strong></td></tr>`;
      }
    }
    html += `</tbody></table></div>
      <div class="text-center p-4">
        <button id="runAllocation" class="btn btn-danger btn-lg px-5">
          <i class="fas fa-play"></i> Thực Hiện Phân Bổ Tự Động
        </button>
      </div></div>`;

    quotaArea.innerHTML = html;

    document.getElementById('runAllocation').addEventListener('click', async () => {
      resultArea.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-danger" style="width:4rem;height:4rem;"></div><h4 class="mt-3">Đang phân bổ học sinh...</h4></div>';

      const runRes = await fetch('/api/phanbohocsinhvaotruong/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nam_thi: year })
      });
      const runJson = await runRes.json();

      if (!runJson.success) {
        resultArea.innerHTML = `<div class="alert alert-danger">Lỗi: ${runJson.message}</div>`;
        return;
      }

      allocationResults = runJson.results;
      renderSavedResults(runJson, year); // Dùng chung hàm hiển thị

      statsInfo.textContent = `Đã phân bổ ${runJson.totalAllocated}/${runJson.totalCandidates} thí sinh thành công!`;
      saveBar.classList.remove('d-none');
    });
  }

  saveBtn.onclick = async () => {
    if (!allocationResults) return;
    const saveRes = await fetch('/api/phanbohocsinhvaotruong/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nam_thi: namThi.value, results: allocationResults })
    });
    const saveJson = await saveRes.json();
    alert(saveJson.success ? "Lưu thành công!" : "Lỗi: " + saveJson.message);
    if (saveJson.success) location.reload();
  };

  cancelBtn.onclick = () => location.reload();
})();
</script>